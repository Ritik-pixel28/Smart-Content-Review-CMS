<div class="checklist-panel" style="padding: 15px; background: #f9f9f9; border-radius: 5px; margin-top: 10px;">
    <h3 style="margin-top: 0;">Checklist</h3>

    {% if instance.checklist_items.all %}
    <!-- Progress Bar -->
    <div style="margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <span style="font-size: 0.9em; font-weight: 600; color: #333;">Progress</span>
            <span id="checklist-progress-text" style="font-size: 0.9em; font-weight: 600; color: #666;">
                0 / 0 (0%)
            </span>
        </div>
        <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
            <div id="checklist-progress-bar"
                style="width: 0%; height: 100%; background: #dc3545; transition: width 0.3s ease, background 0.3s ease;">
            </div>
        </div>
    </div>

    <ul style="list-style: none; padding: 0;">
        {% for item in instance.checklist_items.all %}
        <li
            style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 3px; border-left: 3px solid {% if item.is_done %}#28a745{% else %}#ffc107{% endif %};">
            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                <input type="checkbox" {% if item.is_done %}checked{% endif %} data-item-id="{{ item.id }}"
                    class="checklist-checkbox" style="margin-right: 10px; margin-top: 3px; cursor: pointer;">
                <div>
                    <strong>{{ item.title }}</strong>
                    {% if item.description %}
                    <div style="color: #666; font-size: 0.9em; margin-top: 3px;">{{ item.description }}</div>
                    {% endif %}
                </div>
            </label>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p style="color: #666;">No checklist items yet. Add items via Admin â†’ Checklist Items.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const checkboxes = document.querySelectorAll('.checklist-checkbox');
        const progressBar = document.getElementById('checklist-progress-bar');
        const progressText = document.getElementById('checklist-progress-text');
        const checklistPanel = document.querySelector('.checklist-panel');

        // Function to update progress bar
        function updateProgressBar() {
            const total = checkboxes.length;
            const completed = document.querySelectorAll('.checklist-checkbox:checked').length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            if (progressBar && progressText) {
                progressBar.style.width = percentage + '%';
                progressText.textContent = `${completed} / ${total} (${percentage}%)`;

                // Update colors based on percentage
                if (percentage === 100) {
                    progressBar.style.background = '#28a745'; // Green
                    progressText.style.color = '#28a745';
                } else if (percentage >= 50) {
                    progressBar.style.background = '#ffc107'; // Yellow
                    progressText.style.color = '#666';
                } else {
                    progressBar.style.background = '#dc3545'; // Red
                    progressText.style.color = '#666';
                }
            }
        }

        // Initialize progress bar on load
        updateProgressBar();

        // Auto-scroll to checklist if incomplete items exist
        const hasIncompleteItems = document.querySelectorAll('.checklist-checkbox:not(:checked)').length > 0;
        if (hasIncompleteItems && checklistPanel) {
            setTimeout(() => {
                checklistPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                checklistPanel.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.5)';
                setTimeout(() => {
                    checklistPanel.style.boxShadow = 'none';
                }, 2000);
            }, 500);
        }

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const itemId = this.getAttribute('data-item-id');
                const isChecked = this.checked;

                // Send AJAX request to toggle the item
                fetch(`/checklist/toggle/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Checklist item updated:', data);
                            // Update border color
                            const listItem = this.closest('li');
                            listItem.style.borderLeftColor = data.is_done ? '#28a745' : '#ffc107';

                            // Update progress bar
                            updateProgressBar();
                        } else {
                            console.error('Failed to update checklist item:', data.error);
                            // Revert checkbox state
                            this.checked = !isChecked;
                            alert('Failed to update checklist item. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Revert checkbox state
                        this.checked = !isChecked;
                        alert('An error occurred. Please try again.');
                    });
            });
        });
    });
</script>